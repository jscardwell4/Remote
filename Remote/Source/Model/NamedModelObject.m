//
//  NamedModelObject.m
//  Remote
//
//  Created by Jason Cardwell on 11/3/13.
//  Copyright (c) 2013 Moondeer Studios. All rights reserved.
//

#import "NamedModelObject.h"

@interface NamedModelObject (CoreDataGenerated)
@property (nonatomic) NSString * primitiveName;
@end

@implementation NamedModelObject

@dynamic name, isNameAutoGenerated;

- (void)awakeFromInsert {
  [super awakeFromInsert];
  [self autoGenerateName];
}

- (void)autoGenerateName {
  NSString * base = self.className;
  NSPredicate * predicate = NSPredicateMake(@"name like %@", $(@"%@*", base));
  NSUInteger count = [[self class] countOfObjectsWithPredicate:predicate context:self.managedObjectContext] + 1;
  self.primitiveName = $(@"%@%lu", base, (unsigned long)count);
  self.isNameAutoGenerated = YES;
}

- (void)setName:(NSString *)name {
  [self willChangeValueForKey:@"name"];
  self.primitiveName = name;
  [self didChangeValueForKey:@"name"];
  if (name) self.isNameAutoGenerated = NO;
  else [self autoGenerateName];
}

- (void)updateWithData:(NSDictionary *)data {
  [super updateWithData:data];
  self.name = data[@"name"] ?: self.name;
}

- (MSDictionary *)JSONDictionary {
  MSDictionary * dictionary = [super JSONDictionary];
  if (!self.isNameAutoGenerated)
    SafeSetValueForKey(self.name, @"name", dictionary);
  return dictionary;
}

- (NSString *)commentedUUID {
  NSString * uuid = self.uuid;

  if (uuid) {
    NSString * name = self.name;

    if (name) uuid.comment = MSSingleLineComment(name);
  }

  return uuid;
}

@end
